services:
  test:
    build:
      context: .
      target: development
    container_name: stellar-test
    environment:
      - NODE_ENV=development
      - PORT=3000
      - DATABASE_URL=postgresql://postgres:postgres@db-test:5432/stellar_test?schema=public
      - BETTER_AUTH_URL=http://test.local
      - BETTER_AUTH_SECRET=test-secret-change-in-production
      - BETTER_AUTH_TRUSTED_ORIGINS=http://test.local
      - ENCRYPTION_KEY_FILE=/app/.keys/.encryption-key
    volumes:
      - .:/app
      - /app/node_modules
      - /app/client/node_modules
      - test-keys:/app/.keys
    networks:
      - stellar-network
    depends_on:
      - db-test
    restart: "no"
    entrypoint: ["/bin/sh", "-c", "npx prisma migrate deploy && npm run db:seed && npm run test:coverage"]

  db-test:
    image: postgres:15-alpine
    container_name: stellar-db-test
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=stellar_test
    volumes:
      - test-data:/var/lib/postgresql/data
    networks:
      - stellar-network
    restart: "no"

  app1:
    build:
      context: .
      target: development
    container_name: stellar-app1
    environment:
      - NODE_ENV=development
      - PORT=3000
      - DATABASE_URL=postgresql://postgres:postgres@db-dev:5432/stellar_app1?schema=public
      - BETTER_AUTH_URL=http://app1.local
      - BETTER_AUTH_SECRET=app1-secret-change-in-production
      - BETTER_AUTH_TRUSTED_ORIGINS=http://app1.local
      - ENCRYPTION_KEY_FILE=/app/.keys/.encryption-key
    volumes:
      - .:/app
      - /app/node_modules
      - /app/client/node_modules
      - app1-keys:/app/.keys
    networks:
      - stellar-network
    extra_hosts:
      - "app1.local:host-gateway"
      - "app2.local:host-gateway"
    restart: unless-stopped
    depends_on:
      - db-dev
    entrypoint: ["/app/scripts/dev-entrypoint.sh"]
    command: ["npm", "run", "dev:app"]

  app2:
    build:
      context: .
      target: development
    container_name: stellar-app2
    environment:
      - NODE_ENV=development
      - PORT=3000
      - DATABASE_URL=postgresql://postgres:postgres@db-dev:5432/stellar_app2?schema=public
      - BETTER_AUTH_URL=http://app2.local
      - BETTER_AUTH_SECRET=app2-secret-change-in-production
      - BETTER_AUTH_TRUSTED_ORIGINS=http://app2.local
      - ENCRYPTION_KEY_FILE=/app/.keys/.encryption-key
    volumes:
      - .:/app
      - /app/node_modules
      - /app/client/node_modules
      - app2-keys:/app/.keys
    networks:
      - stellar-network
    extra_hosts:
      - "app1.local:host-gateway"
      - "app2.local:host-gateway"
    restart: unless-stopped
    depends_on:
      - db-dev
    entrypoint: ["/app/scripts/dev-entrypoint.sh"]
    command: ["npm", "run", "dev:app"]

  db-dev:
    image: postgres:15-alpine
    container_name: stellar-db-dev
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_MULTIPLE_DATABASES=stellar_app1,stellar_app2
    volumes:
      - db-dev-data:/var/lib/postgresql/data
      - ./scripts/init-multiple-databases.sh:/docker-entrypoint-initdb.d/init-multiple-databases.sh
    networks:
      - stellar-network
    restart: unless-stopped

  caddy:
    image: caddy:2-alpine
    container_name: stellar-caddy
    ports:
      - "80:80"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ./coverage:/var/www/coverage:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - stellar-network
    restart: unless-stopped
    depends_on:
      - app1
      - app2

volumes:
  test-data:
  db-dev-data:
  test-keys:
  app1-keys:
  app2-keys:
  caddy-data:
  caddy-config:

networks:
  stellar-network:
    driver: bridge
