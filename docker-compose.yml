services:
    test:
        build:
            context: .
            target: development
        container_name: constellate-test
        environment:
            - NODE_ENV=development
            - PORT=3000
            - DATABASE_URL=postgresql://postgres:postgres@db-test:5432/constellate_test?schema=public
            - BASE_URL=http://test.local
            - BETTER_AUTH_SECRET=test-secret-change-in-production
            - BETTER_AUTH_TRUSTED_ORIGINS=http://test.local
            # Test encryption key
            - ENCRYPTION_KEY=${ENCRYPTION_KEY}
        volumes:
            - .:/app
            - /app/node_modules
            - /app/client/node_modules
        networks:
            - constellate-network
        depends_on:
            - db-test
        restart: 'no'
        entrypoint:
            [
                '/bin/sh',
                '-c',
                'npx prisma migrate deploy && npm run db:seed && npm run test:coverage',
            ]

    db-test:
        image: postgres:15-alpine
        container_name: constellate-db-test
        environment:
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=postgres
            - POSTGRES_DB=constellate_test
        volumes:
            - test-data:/var/lib/postgresql/data
        networks:
            - constellate-network
        restart: 'no'

    app1:
        build:
            context: .
            target: development
        container_name: constellate-app1
        environment:
            - NODE_ENV=development
            - PORT=3000
            - DATABASE_URL=postgresql://postgres:postgres@db-dev:5432/constellate_app1?schema=public
            - BASE_URL=http://app1.local
            - BETTER_AUTH_SECRET=app1-secret-change-in-production
            - BETTER_AUTH_TRUSTED_ORIGINS=http://app1.local
            - ENCRYPTION_KEY=${ENCRYPTION_KEY}
            - SMTP_HOST=${SMTP_HOST}
            - SMTP_PORT=${SMTP_PORT}
            - SMTP_SECURE=${SMTP_SECURE}
            - SMTP_USER=${SMTP_USER}
            - SMTP_PASS=${SMTP_PASS}
            - SMTP_FROM=${SMTP_FROM}
            - SEED_USER_PASSWORD=${SEED_USER_PASSWORD}
        volumes:
            - .:/app
            - /app/node_modules
            - /app/client/node_modules
        networks:
            - constellate-network
        extra_hosts:
            - 'app1.local:host-gateway'
            - 'app2.local:host-gateway'
        restart: unless-stopped
        depends_on:
            - db-dev
        entrypoint: ['/app/scripts/dev-entrypoint.sh']
        command: ['npm', 'run', 'dev:app']

    app2:
        build:
            context: .
            target: development
        container_name: constellate-app2
        environment:
            - NODE_ENV=development
            - PORT=3000
            - DATABASE_URL=postgresql://postgres:postgres@db-dev:5432/constellate_app2?schema=public
            - BASE_URL=http://app2.local
            - BETTER_AUTH_SECRET=app2-secret-change-in-production
            - BETTER_AUTH_TRUSTED_ORIGINS=http://app2.local
            - ENCRYPTION_KEY=${ENCRYPTION_KEY}
            - SMTP_HOST=${SMTP_HOST}
            - SMTP_PORT=${SMTP_PORT}
            - SMTP_SECURE=${SMTP_SECURE}
            - SMTP_USER=${SMTP_USER}
            - SMTP_PASS=${SMTP_PASS}
            - SMTP_FROM=${SMTP_FROM}
            - SEED_USER_PASSWORD=${SEED_USER_PASSWORD}
        volumes:
            - .:/app
            - /app/node_modules
            - /app/client/node_modules
        networks:
            - constellate-network
        extra_hosts:
            - 'app1.local:host-gateway'
            - 'app2.local:host-gateway'
        restart: unless-stopped
        depends_on:
            - db-dev
        entrypoint: ['/app/scripts/dev-entrypoint.sh']
        command: ['npm', 'run', 'dev:app']

    db-dev:
        image: postgres:15-alpine
        container_name: constellate-db-dev
        environment:
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=postgres
            - POSTGRES_MULTIPLE_DATABASES=constellate_app1,constellate_app2
        volumes:
            - db-dev-data:/var/lib/postgresql/data
            - ./scripts/init-multiple-databases.sh:/docker-entrypoint-initdb.d/init-multiple-databases.sh
        networks:
            - constellate-network
        restart: unless-stopped

    caddy:
        image: caddy:2-alpine
        container_name: constellate-caddy
        ports:
            - '80:80'
        volumes:
            - ./Caddyfile:/etc/caddy/Caddyfile
            - ./coverage:/var/www/coverage:ro
            - caddy-data:/data
            - caddy-config:/config
        networks:
            - constellate-network
        restart: unless-stopped
        depends_on:
            - app1

volumes:
    test-data:
    db-dev-data:
    caddy-data:
    caddy-config:

networks:
    constellate-network:
        driver: bridge
