name: PR Checks

on:
    pull_request:
        branches:
            - main

jobs:
    check:
        name: Lint, Type-Check, Knip & Build
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Prepare repo
              run: |
                  rm -rf node_modules
                  rm -f package-lock.json
                  npm install --legacy-peer-deps
                  cd client
                  rm -rf node_modules
                  rm -f package-lock.json
                  npm install

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install root dependencies
              run: npm ci --legacy-peer-deps

            - name: Install client dependencies
              run: npm ci --prefix client

            - name: '[Server] Type-Check'
              run: npx tsc --noEmit

            - name: '[Server] Lint'
              run: npx eslint src --ext .ts

            - name: '[Server] Knip'
              run: npm run knip:server

            - name: '[Server] Build'
              run: npm run build:server

            - name: '[Client] Type-Check'
              run: npx tsc --noEmit --project client/tsconfig.json

            - name: '[Client] Lint'
              working-directory: client
              run: npx eslint src --ext .ts,.tsx

            - name: '[Client] Knip'
              working-directory: client
              run: npx knip

            - name: '[Client] Build'
              working-directory: client
              run: npx vite build

    test:
        name: Test
        runs-on: ubuntu-latest
        services:
            postgres:
                image: postgres:15-alpine
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: constellate_test
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432

        env:
            DATABASE_URL: postgresql://postgres:postgres@localhost:5432/constellate_test?schema=public
            BETTER_AUTH_URL: http://test.local
            BETTER_AUTH_SECRET: test-secret-change-in-production
            BETTER_AUTH_TRUSTED_ORIGINS: http://test.local
            NODE_ENV: test

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Prepare repo
              run: |
                  rm -rf node_modules
                  rm -f package-lock.json
                  npm install --legacy-peer-deps
                  cd client
                  rm -rf node_modules
                  rm -f package-lock.json
                  npm install

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install root dependencies
              run: npm ci --legacy-peer-deps

            - name: Install client dependencies
              run: npm ci --prefix client

            - name: Generate Prisma Client
              run: npm run db:generate

            - name: Run database migrations
              run: npx prisma migrate deploy

            - name: Run tests with coverage
              run: npm run test:coverage

            - name: Upload Vitest JUnit report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: vitest-junit
                  path: reports/junit.xml
                  if-no-files-found: ignore
                  retention-days: 7

            - name: Upload coverage reports
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage/
                  retention-days: 7

    test-frontend:
        name: Test (Frontend)
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Prepare repo
              run: |
                  rm -rf node_modules
                  rm -f package-lock.json
                  npm install --legacy-peer-deps
                  cd client
                  rm -rf node_modules
                  rm -f package-lock.json
                  npm install

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install client dependencies
              run: npm ci --prefix client

            - name: Install Playwright browsers
              working-directory: client
              run: npx playwright install chromium

            - name: Run frontend tests with coverage
              run: npm run test:coverage --prefix client

            - name: Upload frontend coverage reports
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report-frontend
                  path: client/coverage/
                  retention-days: 7

    coverage-base:
        name: Coverage (Base Branch)
        runs-on: ubuntu-latest
        if: github.event_name == 'pull_request'
        services:
            postgres:
                image: postgres:15-alpine
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: constellate_test
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432

        env:
            DATABASE_URL: postgresql://postgres:postgres@localhost:5432/constellate_test?schema=public
            BETTER_AUTH_URL: http://test.local
            BETTER_AUTH_SECRET: test-secret-change-in-production
            BETTER_AUTH_TRUSTED_ORIGINS: http://test.local
            NODE_ENV: test

        steps:
            - name: Checkout base branch
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.base_ref }}
              if: steps.base_cache.outputs.cache-hit != 'true'

            - name: Prepare repo
              run: |
                  rm -rf node_modules
                  rm -f package-lock.json
                  npm install --legacy-peer-deps
                  cd client
                  rm -rf node_modules
                  rm -f package-lock.json
                  npm install

            - name: Restore cached base coverage
              id: base_cache
              uses: actions/cache@v4
              with:
                  path: coverage-base-cache/coverage-summary.json
                  key: coverage-base-${{ github.event.pull_request.base.sha }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
              if: steps.base_cache.outputs.cache-hit != 'true'

            - name: Install root dependencies
              run: npm ci --legacy-peer-deps
              if: steps.base_cache.outputs.cache-hit != 'true'

            - name: Install client dependencies
              run: npm ci --prefix client
              if: steps.base_cache.outputs.cache-hit != 'true'

            - name: Generate Prisma Client
              run: npm run db:generate
              if: steps.base_cache.outputs.cache-hit != 'true'

            - name: Run database migrations
              run: npx prisma migrate deploy
              if: steps.base_cache.outputs.cache-hit != 'true'

            - name: Run tests with coverage
              run: npm run test:coverage
              if: steps.base_cache.outputs.cache-hit != 'true'

            - name: Verify coverage summary exists
              if: steps.base_cache.outputs.cache-hit != 'true'
              run: |
                  if [ ! -f "coverage/coverage-summary.json" ]; then
                    echo "❌ Error: coverage-summary.json not found. The json-summary reporter should generate this file."
                    echo "This indicates a problem with the test coverage generation."
                    exit 1
                  fi

            - name: Use cached coverage file
              if: steps.base_cache.outputs.cache-hit == 'true'
              run: |
                  mkdir -p coverage
                  cp coverage-base-cache/coverage-summary.json coverage/coverage-summary.json

            - name: Store coverage in cache path
              if: steps.base_cache.outputs.cache-hit != 'true'
              run: |
                  mkdir -p coverage-base-cache
                  cp coverage/coverage-summary.json coverage-base-cache/coverage-summary.json

            - name: Upload base coverage
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-base
                  path: coverage/coverage-summary.json
                  retention-days: 7

    coverage-base-frontend:
        name: Coverage (Base Branch - Frontend)
        runs-on: ubuntu-latest
        if: github.event_name == 'pull_request'
        steps:
            - name: Checkout base branch
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.base_ref }}
              if: steps.base_cache.outputs.cache-hit != 'true'

            - name: Prepare repo
              run: |
                  rm -rf node_modules
                  rm -f package-lock.json
                  npm install --legacy-peer-deps
                  cd client
                  rm -rf node_modules
                  rm -f package-lock.json
                  npm install

            - name: Restore cached base coverage
              id: base_cache
              uses: actions/cache@v4
              with:
                  path: coverage-base-cache-frontend/coverage-summary.json
                  key: coverage-base-frontend-${{ github.event.pull_request.base.sha }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
              if: steps.base_cache.outputs.cache-hit != 'true'

            - name: Install client dependencies
              run: npm ci --prefix client
              if: steps.base_cache.outputs.cache-hit != 'true'

            - name: Install Playwright browsers
              working-directory: client
              run: npx playwright install chromium
              if: steps.base_cache.outputs.cache-hit != 'true'

            - name: Run frontend tests with coverage
              run: npm run test:coverage --prefix client
              if: steps.base_cache.outputs.cache-hit != 'true'

            - name: Verify coverage summary exists
              if: steps.base_cache.outputs.cache-hit != 'true'
              run: |
                  if [ ! -f "client/coverage/coverage-summary.json" ]; then
                    echo "❌ Error: coverage-summary.json not found. The json-summary reporter should generate this file."
                    echo "This indicates a problem with the test coverage generation."
                    exit 1
                  fi

            - name: Use cached coverage file
              if: steps.base_cache.outputs.cache-hit == 'true'
              run: |
                  mkdir -p client/coverage
                  cp coverage-base-cache-frontend/coverage-summary.json client/coverage/coverage-summary.json

            - name: Store coverage in cache path
              if: steps.base_cache.outputs.cache-hit != 'true'
              run: |
                  mkdir -p coverage-base-cache-frontend
                  cp client/coverage/coverage-summary.json coverage-base-cache-frontend/coverage-summary.json

            - name: Upload base coverage
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-base-frontend
                  path: client/coverage/coverage-summary.json
                  retention-days: 7

    coverage-check:
        name: Coverage Check
        runs-on: ubuntu-latest
        needs: [test, coverage-base]
        if: github.event_name == 'pull_request'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Download PR coverage
              uses: actions/download-artifact@v4
              with:
                  name: coverage-report
                  path: coverage-pr/

            - name: Download base coverage
              uses: actions/download-artifact@v4
              with:
                  name: coverage-base
                  path: coverage-base/

            - name: Check if base coverage exists
              id: check_base
              run: |
                  if [ -f "coverage-base/coverage-summary.json" ]; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                  fi

            - name: Verify coverage files exist
              if: steps.check_base.outputs.exists == 'true'
              run: |
                  for dir in coverage-pr coverage-base; do
                    if [ ! -f "$dir/coverage-summary.json" ]; then
                      echo "❌ Error: $dir/coverage-summary.json not found. The json-summary reporter should generate this file."
                      echo "This indicates a problem with the test coverage generation."
                      exit 1
                    fi
                  done

            - name: Compare coverage
              if: steps.check_base.outputs.exists == 'true'
              run: |
                  node scripts/compare-coverage.js coverage-pr/coverage-summary.json coverage-base/coverage-summary.json
              continue-on-error: false

            - name: Skip coverage comparison (first PR)
              if: steps.check_base.outputs.exists != 'true'
              run: |
                  echo "⚠️  No base coverage found. This might be the first PR to main."
                  echo "Coverage comparison skipped. Future PRs will be checked against this baseline."

    coverage-check-frontend:
        name: Coverage Check (Frontend)
        runs-on: ubuntu-latest
        needs: [test-frontend, coverage-base-frontend]
        if: github.event_name == 'pull_request'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Download PR coverage
              uses: actions/download-artifact@v4
              with:
                  name: coverage-report-frontend
                  path: coverage-pr-frontend/

            - name: Download base coverage
              uses: actions/download-artifact@v4
              with:
                  name: coverage-base-frontend
                  path: coverage-base-frontend/

            - name: Check if base coverage exists
              id: check_base
              run: |
                  if [ -f "coverage-base-frontend/coverage-summary.json" ]; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                  fi

            - name: Verify coverage files exist
              if: steps.check_base.outputs.exists == 'true'
              run: |
                  for dir in coverage-pr-frontend coverage-base-frontend; do
                    if [ ! -f "$dir/coverage-summary.json" ]; then
                      echo "❌ Error: $dir/coverage-summary.json not found. The json-summary reporter should generate this file."
                      echo "This indicates a problem with the test coverage generation."
                      exit 1
                    fi
                  done

            - name: Compare frontend coverage
              if: steps.check_base.outputs.exists == 'true'
              run: |
                  node scripts/compare-coverage.js coverage-pr-frontend/coverage-summary.json coverage-base-frontend/coverage-summary.json
              continue-on-error: false

            - name: Skip frontend coverage comparison (first PR)
              if: steps.check_base.outputs.exists != 'true'
              run: |
                  echo "⚠️  No base frontend coverage found. This might be the first PR to main."
                  echo "Frontend coverage comparison skipped. Future PRs will be checked against this baseline."

    all-checks:
        name: All Checks Passed
        runs-on: ubuntu-latest
        needs: [check, test, test-frontend, coverage-check, coverage-check-frontend]
        if: always()
        steps:
            - name: Check all jobs
              run: |
                  # Required checks (must pass)
                  if [ "${{ needs.check.result }}" != "success" ]; then
                    echo "❌ Code check failed"
                    exit 1
                  fi
                  if [ "${{ needs.test.result }}" != "success" ]; then
                    echo "❌ Backend test check failed"
                    exit 1
                  fi
                  if [ "${{ needs.test-frontend.result }}" != "success" ]; then
                    echo "❌ Frontend test check failed"
                    exit 1
                  fi

                  # Coverage checks (required for PRs, but may be skipped for first PR)
                  if [ "${{ github.event_name }}" == "pull_request" ] && \
                     [ "${{ needs.coverage-check.result }}" != "success" ] && \
                     [ "${{ needs.coverage-check.result }}" != "skipped" ]; then
                    echo "❌ Backend coverage check failed"
                    exit 1
                  fi
                  if [ "${{ github.event_name }}" == "pull_request" ] && \
                     [ "${{ needs.coverage-check-frontend.result }}" != "success" ] && \
                     [ "${{ needs.coverage-check-frontend.result }}" != "skipped" ]; then
                    echo "❌ Frontend coverage check failed"
                    exit 1
                  fi

                  echo "✅ All checks passed!"
